# 6. 다양한 연관관계 매핑

엔티티 연관관계 매핑시 고려할 것

1. 다중성
2. 단방향, 양방향
3. 연관관계의 주인

(+ 다중성에서 왼쪽을 항상 주인이라고 가정)  
(+ 회원, 상품, 주문 예제)

## 다대일

다대일관계의 반대는 항상 일대다 관계.  
일대다 관계의 반대는 항상 다대일 관계.  
외래 키는 항상 다쪽에 있다. -> 객체 양방향 관계에서 연관관계의 주인은 항상 다쪽이다.

#### 다대일 단방향

연관관계를 매핑하는 엔티티에서는 반대 엔티티를 참조할 수 있지만, 반대 엔티티에서는 다른 엔티티를 참조하는 필드가 없기 때문에 자신의 반대 엔티티를 참조할 수 없다.

#### 다대일 양방향 [N:1, 1:N]

- 양방향은 외래 키가 있는 쪽이 연관관계의 주인이다  
   JPA는 외래 키를 관리할 때 연관관계의 주인만 사용한다. 주인이 아닌 쪽은 조회를 위한 JPQL이나 객체 그래프 탐색에 사용한다.
- 양방향 연관관계는 항상 서로를 참조해야 한다  
   항상 서로를 참조하도록 연관관계 편의 메소드를 작성한다. 양쪽에 작성 시 무한루프 주의.

## 일대다

다대일의 반대 방향이다. 엔티티를 하나 이상 참조할 수 있으므로 자바 컬렉션 중 하나를 사용한다.

#### 일대다 단방향 [1:N]

일대다 단방향 관계는 다쪽이 아닌곳에서 반대쪽 테이블(다쪽)에 있는 외래 키를 관리한다.

일대다 단방향 관계를 매핑할 때는 `@JoinColumn`을 명시해야 한다.(안 하면 조인 테이블 전략 사용)

- 일대다 단방향 매핑 단점  
   매핑한 객체가 관리하는 외래 키가 다른 테이블에 있다는 것이다. 엔티티 저장과 연관관계 처리를 위해 SQL을 두 번 실행한다. (INSERT, UPDATE(FK))

=> 일대다 단방향 매핑 보다는 다대일 양방향 매핑을 사용하자!

#### 일대다 양방향 [1:N, N:1]

일대다 양방향 매핑은 존재하지 않는다. 대신 다대일 양방향 매핑을 사용해야 한다.

양방향 매핑에서 다대일 관계는 항상 다 쪽에 외래키가 있기 때문에 `@OneToMany`는 주인이 될 수 없다.  
-> `@ManyToOne`이 항상 주인

만약 일대다 양방향 매핑을 사용하려면 일대다 단방향 매핑 반대편에 같은 외래키를 사용하는 다대일 단방향 매핑을 **읽기 전용**으로 하나 추가.

다대일과 일대다가 같은 키를 관리해 문제 발생 -> 반대편인 다대일쪽 `@JoinColumn`에 속성 값을 입력해 읽기만 가능하도록 설정.

```java
@ManyToOne
@JoinColumn(name = "TEAM_ID", insertable = false,
  updatable = false)
private Team team; //Team -> Member (팀이 주인, 1:N)
```

다대일 단방향 매핑을 읽기 전용으로 추가해 일대 양방향처럼 보이도록 하는것이다. 단점은 그대로 가진다.

=> 일대다 단방향 매핑보다 다대일 양방향 매핑을 사용하자!

## 일대일 [1:1]

양쪽이 서로 하나의 관계만 가진다.

**일대일 관계 특징**

- 일대일 관계는 그 반대도 일대일 관계다.
- 테이블 관계에서 항상 다 쪽이 외래 키를 가진다. 일대일 관계는 주 테이블이나 대상 테이블 어느곳이나 외래 키를 가질 수 있다.

**외래키 누가 가질지 선택하기**

- 주 테이블에 외래키  
   외래키를 객체 참조와 비슷하게 사용할 수 있어 객체지향 개발자가 선호. 주 테이블 확인 -> 대상 테이블과 연관관계 있는지 알 수 있음.
- 대상 테이블에 외래키  
   전통적인 DB 개발자들 선호. 테이블 관계를 일대일에서 일대다로 변경할때 테이블 구조 그대로 유지 가능.

### 주 테이블에 외래키

JPA도 주 테이블에 외래키가 있으면 좀 더 편리하게 매핑할 수 있다.

### 대상 테이블에 외래키

#### 단방향

일대일 관계 중 대상 테이블에 외래키가 있는 단방향 관계는 매핑 방법이 없다.

단방향 관계를 수정(주테이블, 대상테이블) 하거나 양방향 관계로 변경해야 한다.

#### 양방향

일대일 관계에서 대상 테이블에 외래키를 두려면 양방향으로 매핑한다. 대신 주 엔티티 대신에 대상 엔티티를 연관관계의 주인으로 만들어 외래키를 관리하도록 한다.

## 다대다 [N:N]

관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없다.

보통 다대다 관게를 일대다, 다대일 관계로 풀어내는 연결 테이블을 사용한다.

그런데 객체는 객체 2개로 다대다 관계를 만들 수 있다. 컬렉션을 사용해 각각 참조하면 된다. `@ManyToMany`으로 다대다 관계 매핑.

#### 다대다: 단방향

별도의 연결하는 엔티티 없이 매핑을 할 수 있다. `@ManyToMany`, `@JoinTable`을 사용해 연결 테이블을 바로 매핑.

`@JoinTable` 속성

- `name`: 연결 테이블 지정
- `joinColumns`: 현재 방향과 매핑할 조인 컬럼 정보 지정.
- `inverseJoinColumn`: 반대 방향과 매핑할 조인 컬럼 정보 지정.

_저장: 두 테이블의 연관관계를 설정하고 한 테이블의 값을 저장 하면 연결 테이블에도 값이 저장됨_  
_객체그래프탐색: 연결 테이블과 한 테이블을 조인해서 연관된 객체 탐색_

#### 다대다: 양방향

다대다 매핑이므로 역방향도 `@ManyToMany`를 설정하고 원하는 곳에 `mappedBy`로 연관관계의 주인을 지정한다.

양방향 연관관계는 연관관계 편의 메소드를 추가해서 연관관계를 관리하는것이 좋다.

#### 다대다: 매핑의 한계와 극복, 연결 엔티티 사용

**문제**

`@ManyToMany`를 사용하면 연결 테이블을 자동으로 처리해 도메인 모델이 단순해지고 편리하다. 하지만 실무에서 사용하기에는 한계가 있다.

보통 연결 테이블에 추가 컬럼이 더 필요하다! (ex. 회원-상품간 연결테이블: 주문수량, 주문일 등)

연결 테이블에 컬럼을 추가하면 `@ManyToMany`를 사용할 수 없다.(양 테이블에 추가한 컬럼을 매핑할 수 X)

**해결**

그래서 연결 테이블을 매핑하는 **연결 엔티티**를 만들고 추가 컬럼을 매핑한다.

연결 엔티티를 사용하면 별도의 **식별자 클래스**를 만들어 복합 키(기본키+외래키)를 관리한다.

- 복합 기본 키  
   연결 엔티티의 기본키는 테이블1 기본키와 테이블2 기본키로 이루어진 복합 기본키다. JPA에서 복합키를 사용하려면 별도의 식별자 클래스를 만들어야 한다.  
  `@IdClass`로 식별자 클래스를 지정하면 된다.
- 복합 기본 키를 위한 식별자 클래스 특징
  - 복합 키는 별도의 식별자 클래스로 만들어야 한다.
  - `Seriallizable`을 구현해야 한다.
  - `equals`와 `hashCode` 메소드를 구현해야 한다.
  - 기본 생성자가 있어야 한다.
  - 식별자 클래스는 public이어야 한다.
  - `@IdClass`를 사용하는 방법 외에 `@EmbeddedId`를 사용하는 방법도 있다.
- 식별 관계(Identifying Relationship)  
   부모 테이블의 기본 키를 받아 자신의 기본키 + 외래키로 사용하는 것.

_저장: 연결 엔티티는 **DB에 저장될 때** 연결된 테이블 1의 식별자와 테이블2의 식별자를 가져와 자신의 기본 키 값으로 사용_

-> 복합키를 사용하면 ORM 매핑에서 처리할 일이 많아진다.

#### 다대다: 새로운 기본 키 사용

추천하는 기본 키 생성 전략은 DB에서 자동으로 생성해주는 대리 키를 Long 값으로 사용하는 것이다.  
(연결 테이블에 대리키 사용)

거의 영구히 쓸 수 있고 비즈니스에 의존하지 않는다. 복합키가 아니므로 간단히 매핑을 완성한다.

#### 다대다 연관관계 정리

다대다 관계를 일대다, 다대일 관계로 풀어내기 위해 연결 테이블을 만들 때 식별자를 어떻게 구성할지 선택한다.

- 식별 관계: 받아온 식별자를 기본키+외래키로 사용
- 비식별 관계: 받아온 식별자는 외래키로, 새로운 식별자 추가

=> 객체 입장에서는 비식별 관계를 사용하는 것이 단순하고 편리하게 ORM 매핑을 할 수 있다.  
**=> 식별 관계보다 비식별 관계 추천**
